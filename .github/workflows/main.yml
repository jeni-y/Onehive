name: Deploy Client

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: "Client Name (lowercase, no spaces)"
        required: true

      framework:
        description: "Framework"
        required: true
        type: choice
        options: [php, node, python, go, java]

      app_domain:
        description: "Client Domain"
        required: true

      repo_url:
        description: "GitHub repo (owner/repo)"
        required: true

      repo_branch:
        description: "Git branch"
        required: false
        default: "main"

      client_github_token:
        description: "Client GitHub PAT (optional)"
        required: false

jobs:
  deploy:
    runs-on: self-hosted

    env:
      ACTIONS_STEP_DEBUG: true
      ACTIONS_RUNNER_DEBUG: true

    steps:
    # -----------------------------
    # 1Ô∏è‚É£ Checkout PLATFORM repo
    # -----------------------------
    - name: Checkout platform repo
      uses: actions/checkout@v4

    # -----------------------------
    # 2Ô∏è‚É£ Set environment variables
    # -----------------------------
    - name: Set environment variables
      run: |
        set -euo pipefail

        echo "CLIENT_NAME=${{ github.event.inputs.client_name }}" >> $GITHUB_ENV
        echo "FRAMEWORK=${{ github.event.inputs.framework }}" >> $GITHUB_ENV
        echo "APP_DOMAIN=${{ github.event.inputs.app_domain }}" >> $GITHUB_ENV
        echo "REPO_URL=${{ github.event.inputs.repo_url }}" >> $GITHUB_ENV
        echo "REPO_BRANCH=${{ github.event.inputs.repo_branch }}" >> $GITHUB_ENV
        echo "CLIENT_GITHUB_TOKEN=${{ github.event.inputs.client_github_token }}" >> $GITHUB_ENV
        echo "DOCKER_REGISTRY=docker.io/${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV

        echo "DB_USER=${{ github.event.inputs.client_name }}" >> $GITHUB_ENV
        echo "DB_NAME=${{ github.event.inputs.client_name }}" >> $GITHUB_ENV
        echo "DB_PASSWORD=postgres" >> $GITHUB_ENV

    # -----------------------------
    # 3Ô∏è‚É£ Mask GitHub token
    # -----------------------------
    - name: Mask GitHub token
      if: ${{ github.event.inputs.client_github_token }}
      run: echo "::add-mask::${{ github.event.inputs.client_github_token }}"

    # -----------------------------
    # 4Ô∏è‚É£ Clone CLIENT repository
    # -----------------------------
    - name: Clone client repository
      run: |
        set -euo pipefail
        rm -rf app

        if [ -n "$CLIENT_GITHUB_TOKEN" ]; then
          git clone -b "$REPO_BRANCH" https://$CLIENT_GITHUB_TOKEN@github.com/$REPO_URL app
        else
          git clone -b "$REPO_BRANCH" https://github.com/$REPO_URL app
        fi

        ls -la app

    # -----------------------------
    # 5Ô∏è‚É£ Validate app structure
    # -----------------------------
    - name: Validate application
      run: |
        set -euxo pipefail
        test -d app || (echo "‚ùå App directory missing" && exit 1)

    # -----------------------------
    # üîç Detect DB schema.sql
    # -----------------------------
    - name: Detect DB schema
      run: |
        set -euo pipefail

        if [ -f app/schema.sql ]; then
          echo "DB_SCHEMA_PRESENT=true" >> $GITHUB_ENV
          echo "‚úÖ schema.sql found"
        else
          echo "DB_SCHEMA_PRESENT=false" >> $GITHUB_ENV
          echo "‚ÑπÔ∏è No schema.sql provided"
        fi

    # -----------------------------
    # 6Ô∏è‚É£ Inject DB schema into Helm chart
    # -----------------------------
    - name: Inject DB schema
      if: env.DB_SCHEMA_PRESENT == 'true'
      run : |
        set -euo pipefail
        mkdir -p helm/paas-chart/app/db
        cp app/schema.sql helm/paas-chart/app/db/schema.sql
        echo "‚úÖ schema.sql injected into Helm chart"

    # -----------------------------
    # 7Ô∏è‚É£ Docker login
    # -----------------------------
    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # -----------------------------
    # 8Ô∏è‚É£ Build & Push Docker image
    # -----------------------------
    - name: Build & push Docker image
      run: |
        set -euo pipefail

        DOCKERFILE="docker/$FRAMEWORK/dockerfile"
        IMAGE="$DOCKER_REGISTRY/$CLIENT_NAME:$FRAMEWORK-latest"

        test -f "$DOCKERFILE" || (echo "‚ùå Dockerfile missing" && exit 1)

        docker build -f "$DOCKERFILE" -t "$IMAGE" app
        docker push "$IMAGE"

    # -----------------------------
    # 9Ô∏è‚É£ Setup kubectl
    # -----------------------------
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    # -----------------------------
    # üîü Setup Helm
    # -----------------------------
    - name: Setup Helm
      uses: azure/setup-helm@v4

    # -----------------------------
    # üîç Verify cluster
    # -----------------------------
    - name: Verify cluster
      run: |
        set -eux
        kubectl cluster-info
        kubectl get nodes

    # -----------------------------
    # üîç Namespace
    # -----------------------------
    - name: Ensure namespace exists
      run: |
        set -eux
        kubectl create namespace paas-$CLIENT_NAME --dry-run=client -o yaml | kubectl apply -f -

    # -----------------------------
    # üöÄ Helm Deploy
    # -----------------------------
    - name: Deploy using Helm
      run: |
        set -euo pipefail

        helm upgrade --install "$CLIENT_NAME" ./helm/paas-chart \
          --namespace "paas-$CLIENT_NAME" \
          --set APP_NAME="$CLIENT_NAME" \
          --set APP_IMAGE="$DOCKER_REGISTRY/$CLIENT_NAME:$FRAMEWORK-latest" \
          --set APP_DOMAIN="$APP_DOMAIN" \
          --set DB_SCHEMA_ENABLED="$DB_SCHEMA_PRESENT" \
          --set DB_USER="$DB_USER" \
          --set DB_NAME="$DB_NAME" \
          --wait \
          --timeout 15m \
          --debug

    # -----------------------------
    # üî• Debug on failure
    # -----------------------------
    - name: Kubernetes debug info (on failure)
      if: failure()
      run: |
        echo "==== PODS ===="
        kubectl get pods -n paas-$CLIENT_NAME

        echo "==== DESCRIBE PODS ===="
        kubectl describe pods -n paas-$CLIENT_NAME

        echo "==== LOGS ===="
        for pod in $(kubectl get pods -n paas-$CLIENT_NAME -o name); do
          kubectl logs -n paas-$CLIENT_NAME $pod || true
        done

    # -----------------------------
    # üåê Ingress URL
    # -----------------------------
    - name: Get ingress URL
      run: |
        kubectl get ingress -n paas-$CLIENT_NAME
