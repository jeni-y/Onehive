name: Deploy Client

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: "Client Name (lowercase, no spaces)"
        required: true

      framework:
        description: "Framework (php | node | python | go | java)"
        required: true
        type: choice
        options:
          - php
          - node
          - python
          - go
          - java

      app_domain:
        description: "Client Domain"
        required: true

      repo_url:
        description: "GitHub repo (owner/repo)"
        required: true

      repo_branch:
        description: "Git branch"
        required: false
        default: "main"

      database_required:
        description: "Database required?"
        required: true
        type: boolean
        default: false

      client_github_token:
        description: "Client GitHub Personal Access Token (for private repo, optional)"
        required: false

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    # -----------------------------
    # 1️⃣ Checkout PLATFORM repo
    # -----------------------------
    - name: Checkout platform repo
      uses: actions/checkout@v4

    # -----------------------------
    # 2️⃣ Set environment variables
    # -----------------------------
    - name: Set environment variables
      run: |
        echo "CLIENT_NAME=${{ github.event.inputs.client_name }}" >> $GITHUB_ENV
        # normalize framework to lowercase
        echo "FRAMEWORK=$(echo "${{ github.event.inputs.framework }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
        echo "APP_DOMAIN=${{ github.event.inputs.app_domain }}" >> $GITHUB_ENV
        echo "REPO_URL=${{ github.event.inputs.repo_url }}" >> $GITHUB_ENV
        echo "REPO_BRANCH=${{ github.event.inputs.repo_branch }}" >> $GITHUB_ENV
        echo "DATABASE_REQUIRED=${{ github.event.inputs.database_required }}" >> $GITHUB_ENV
        echo "CLIENT_GITHUB_TOKEN=${{ github.event.inputs.client_github_token }}" >> $GITHUB_ENV
        echo "DOCKER_REGISTRY=docker.io/${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV

    # -----------------------------
    # 3️⃣ Mask client GitHub token
    # -----------------------------
    - name: Mask GitHub token
      if: ${{ github.event.inputs.client_github_token }}
      run: echo "::add-mask::${{ github.event.inputs.client_github_token }}"

    # -----------------------------
    # 4️⃣ Clone CLIENT repository
    # -----------------------------
    - name: Clone client repository
      run: |
        rm -rf app
        if [ -n "$CLIENT_GITHUB_TOKEN" ]; then
          git clone --depth 1 -b $REPO_BRANCH https://$CLIENT_GITHUB_TOKEN@github.com/$REPO_URL app
        else
          git clone --depth 1 -b $REPO_BRANCH https://github.com/$REPO_URL app
        fi

    # -----------------------------
    # 5️⃣ Validate app structure
    # -----------------------------
    - name: Validate application
      run: |
        if [ ! -d "app" ]; then
          echo "❌ App directory missing"
          exit 1
        fi

    # -----------------------------
    # 6️⃣ Docker login
    # -----------------------------
    - name: Log in to Docker registry
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # -----------------------------
    # 7️⃣ Build & Push Docker image
    # -----------------------------
    - name: Build & push Docker image
      run: |
        DOCKERFILE="docker/$FRAMEWORK/dockerfile"
        if [ ! -f "$DOCKERFILE" ]; then
          echo "❌ Dockerfile for framework '$FRAMEWORK' not found!"
          exit 1
        fi

        IMAGE="$DOCKER_REGISTRY/$CLIENT_NAME:$FRAMEWORK-latest"
        echo "Building Docker image: $IMAGE using $DOCKERFILE"

        docker build -f "$DOCKERFILE" -t "$IMAGE" ./app
        docker push "$IMAGE"

        echo "✅ Docker image pushed: $IMAGE"

    # -----------------------------
    # 8️⃣ Setup kubectl
    # -----------------------------
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    # -----------------------------
    # 9️⃣ Setup Helm
    # -----------------------------
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Verify cluster connection
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: Ensure namespace exists
      run: |
        if ! kubectl get namespace paas-$CLIENT_NAME >/dev/null 2>&1; then
        kubectl create namespace paas-$CLIENT_NAME
        fi

    # -----------------------------
    # 1️⃣1️⃣ Deploy using Helm
    # -----------------------------
    - name: Deploy to Kubernetes
      run: |
        helm upgrade --install "$CLIENT_NAME" ./helm/paas-chart \
        -n "paas-$CLIENT_NAME" \
        --create-namespace \
        --set app.domain="$APP_DOMAIN" \
        --set app.image="$DOCKER_REGISTRY/$CLIENT_NAME:$FRAMEWORK-latest" \
        --set database.enabled="$DATABASE_REQUIRED"

    # -----------------------------
    # 1️⃣2️⃣ Get ingress URL
    # -----------------------------
    - name: Get ingress URL
      run: |
        echo "Ingress URL:"
        kubectl get ingress -n "paas-$CLIENT_NAME" "$CLIENT_NAME" \
          -o jsonpath='{.spec.rules[0].host}' | sed 's/^/http:\/\//'