name: Deploy Client

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: "Client Name"
        required: true

      framework:
        description: "Framework (php, node, python, go, java)"
        required: true

      app_domain:
        description: "Client Domain"
        required: true

      db_enabled:
        description: "Enable Database"
        required: true
        default: "false"

      # üîπ NEW: Client GitHub repo (owner/repo)
      repo_url:
        description: "GitHub repo (owner/repo)"
        required: true

      # üîπ NEW: Branch
      repo_branch:
        description: "Git branch"
        required: false
        default: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # 1Ô∏è‚É£ Checkout PLATFORM repo
    # -----------------------------
    - name: Checkout platform code
      uses: actions/checkout@v3

    # -----------------------------
    # 2Ô∏è‚É£ Set environment variables
    # -----------------------------
    - name: Set environment variables
      run: |
        echo "CLIENT_NAME=${{ github.event.inputs.client_name }}" >> $GITHUB_ENV
        echo "FRAMEWORK=${{ github.event.inputs.framework }}" >> $GITHUB_ENV
        echo "APP_DOMAIN=${{ github.event.inputs.app_domain }}" >> $GITHUB_ENV
        echo "REPO_URL=${{ github.event.inputs.repo_url }}" >> $GITHUB_ENV
        echo "REPO_BRANCH=${{ github.event.inputs.repo_branch }}" >> $GITHUB_ENV
        echo "DOCKER_REGISTRY=myrepo" >> $GITHUB_ENV

    # -----------------------------
    # 3Ô∏è‚É£ CLONE CLIENT REPOSITORY (NEW)
    # -----------------------------
    - name: Clone client GitHub repository
      run: |
        rm -rf app
        git clone \
          -b $REPO_BRANCH \
          https://${{ secrets.CLIENT_GITHUB_TOKEN }}@github.com/$REPO_URL \
          app

    # -----------------------------
    # 4Ô∏è‚É£ Log in to Docker registry
    # -----------------------------
    - name: Log in to Docker registry
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # -----------------------------
    # 5Ô∏è‚É£ Build and push Docker image
    # -----------------------------
    - name: Build and Push Docker Image
      run: |
        echo "Building Docker image for client: $CLIENT_NAME, framework: $FRAMEWORK"
        ./scripts/build_push.sh $CLIENT_NAME $FRAMEWORK $DOCKER_REGISTRY

    # -----------------------------
    # 6Ô∏è‚É£ Setup kubectl
    # -----------------------------
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: '1.30.0'

    # -----------------------------
    # 7Ô∏è‚É£ Setup Helm
    # -----------------------------
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    # -----------------------------
    # 8Ô∏è‚É£ Deploy to Kubernetes
    # -----------------------------
    - name: Deploy with Helm
      run: |
        echo "Deploying client $CLIENT_NAME to namespace paas-$CLIENT_NAME"
        helm upgrade --install $CLIENT_NAME helm/paas-chart \
          --set APP_NAME=$CLIENT_NAME \
          --set NAMESPACE=paas-$CLIENT_NAME \
          --set APP_DOMAIN=$APP_DOMAIN \
          --set APP_IMAGE=$DOCKER_REGISTRY/$CLIENT_NAME:$FRAMEWORK-latest
          --set database.enabled=${{github.event.inputs.db_enabled}}
